<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFC 简易钱包（NTAG213 极简版，无签名）</title>
<style>
  :root { color-scheme: light dark; --bg:#0b0c0f; --card:#12141a; --muted:#7a8193; --text:#e8ebf1; --brand:#3b82f6; --danger:#ef4444; --ok:#22c55e; --warn:#f59e0b; --border:#202534; }
  html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Noto Sans SC,Arial,sans-serif;background:#0b0c0f;color:var(--text)}
  .wrap{max-width:920px;margin:0 auto;padding:16px}
  h1{font-size:1.25rem;margin:12px 0 8px} h2{font-size:1.05rem;margin:18px 0 8px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:12px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}.col{flex:1 1 240px;min-width:240px}
  label{display:block;font-size:.9rem;color:var(--muted);margin:6px 0 4px}
  input,textarea{width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1219;color:var(--text)}
  textarea{min-height:100px;resize:vertical}
  button{padding:10px 14px;border:1px solid var(--border);background:#111726;color:var(--text);border-radius:10px;cursor:pointer}
  button.primary{background:var(--brand);border-color:transparent;color:#fff}
  button.warn{background:var(--warn);border-color:transparent;color:#000}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--danger)}
  .hr{height:1px;background:var(--border);margin:10px 0}
  .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>NFC 简易钱包（NTAG213 极简版，无签名）</h1>
  <div class="muted">
    - 为适配 NTAG213（约 144 字节），仅存极简 JSON：{"v":1,"a":"账号","b":余额,"n":序号}<br>
    - 无签名、无公钥，容易被复制，仅供练习/玩具用途。<br>
    - 管理员密码（初始化/充值需要）：50c89cd7bda16185<br>
    - 使用 Android Chrome + HTTPS/localhost。读写时贴紧并保持不动。
  </div>

  <div class="card">
    <h2>读取标签</h2>
    <div class="row">
      <div class="col"><button id="btnRead" class="primary">读取标签</button></div>
      <div class="col"><div id="readStatus" class="muted">尚未读取</div></div>
    </div>
    <div class="hr"></div>
    <label>标签内容（JSON 原文）</label>
    <textarea id="tagJson" readonly></textarea>
  </div>

  <div class="card">
    <h2>初始化/重置（需要管理员密码）</h2>
    <div class="grid-2">
      <div>
        <label>初始余额（正整数，最小单位）</label>
        <input id="initBalance" type="number" min="0" step="1" value="100">
      </div>
      <div>
        <label>账户标识（留空自动生成短ID）</label>
        <input id="initAccount" placeholder="如空自动生成">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnInit" class="warn">初始化/重置（覆盖标签）</button>
      <span class="muted">极简格式，确保适配 NTAG213 容量。</span>
    </div>
  </div>

  <div class="card">
    <h2>充值（需要管理员密码）</h2>
    <div class="grid-2">
      <div>
        <label>充值金额（正整数）</label>
        <input id="topupAmount" type="number" min="1" step="1" value="10">
      </div>
      <div class="muted">先读卡，再写回更新。</div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnTopup" class="primary">读取并充值</button>
      <span id="topupStatus" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h2>转账（A → B）</h2>
    <div class="grid-2">
      <div>
        <label>转账金额（正整数）</label>
        <input id="transferAmount" type="number" min="1" step="1" value="10">
      </div>
      <div class="muted">流程：先贴 A → 弹确认 → 再贴 B → 写 A → 写 B。A 与 B 必须不同账户。</div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnTransfer" class="primary">开始转账</button>
      <span id="transferStatus" class="muted"></span>
    </div>
  </div>

  <div class="muted" style="margin-top:8px">
    提示：若遇到“写入失败”，请确认使用 HTTPS、开启 NFC、贴紧标签，或尝试换位/换角度再试。
  </div>
</div>

<script>
/* 配置：管理员密码（固定） */
const ADMIN_PASSWORD = "50c89cd7bda16185";

/* 工具 */
const enc = new TextEncoder(), dec = new TextDecoder();
function uidShort(prefix="acct"){
  // 生成 4 字节随机，编码为 8 位十六进制，足够短小
  const a = crypto.getRandomValues(new Uint8Array(4));
  return `${prefix}-${[...a].map(x=>x.toString(16).padStart(2,"0")).join("")}`;
}

/* 极简数据结构：
   { v:1, a:"account", b:<balance int>, n:<nonce int> }
   - 控制字段名极短，值也尽量短，保证 << 144B
*/
function sanitizeMinimal(obj){
  return {
    v: 1,
    a: String(obj?.a || ""),
    b: Number.isFinite(obj?.b) ? Math.max(0, Math.floor(obj.b)) : 0,
    n: Number.isFinite(obj?.n) ? Math.max(0, Math.floor(obj.n)) : 0
  };
}

/* Web NFC */
function ensureNFC(){ if(!("NDEFReader" in window)) throw new Error("此浏览器不支持 Web NFC（请用 Android Chrome 并开启 NFC）"); }

async function nfcReadOnce(){
  ensureNFC();
  const reader = new NDEFReader();
  await reader.scan();
  return new Promise((resolve, reject)=>{
    const timer = setTimeout(()=>reject(new Error("读取超时")), 30000);
    reader.onreadingerror = ()=>{ clearTimeout(timer); reject(new Error("读取失败")); };
    reader.onreading = (ev)=>{
      clearTimeout(timer);
      try{
        const { message } = ev;
        for(const rec of message.records){
          if(rec.recordType==="text" || rec.mediaType==="application/json"){
            const text = rec.data ? dec.decode(rec.data) : "";
            resolve(text);
            return;
          }
        }
        resolve("");
      }catch(e){ reject(e); }
    };
  });
}

async function nfcWriteText(text){
  ensureNFC();
  // 长度保护：NTAG213 约 144B，我们尽量控制在 120B 内
  if (new Blob([text]).size > 120) {
    throw new Error("数据过大（超过 NTAG213 建议长度）");
  }
  const writer = new NDEFReader();
  await writer.write({ records: [{ recordType: "text", data: text }] });
}

/* UI 辅助 */
const $ = (id)=>document.getElementById(id);
const S = { read: $("readStatus"), tagJson: $("tagJson"), topup: $("topupStatus"), transfer: $("transferStatus") };

function showJSON(target, obj){
  target.value = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
}

function parseMinimal(text){
  try{
    const obj = JSON.parse(text);
    if (typeof obj !== "object" || obj === null) return null;
    // 允许没有 v 字段的旧空卡，但我们仅处理包含 a/b 的
    const clean = sanitizeMinimal(obj);
    if (!clean.a) return null;
    return clean;
  }catch{ return null; }
}

async function requireAdminPassword(purpose){
  const input = prompt(`${purpose}\n请输入管理员密码：`);
  if (input === null) return false;
  if (input !== ADMIN_PASSWORD) { alert("管理员密码错误"); return false; }
  return true;
}

/* 事件 */
window.addEventListener("load", ()=>{
  $("btnRead").addEventListener("click", async ()=>{
    S.read.textContent = "请贴近标签读取...";
    S.read.className = "muted";
    try{
      const text = await nfcReadOnce();
      if (!text) { S.read.textContent = "读取完成：无文本记录（可能是空卡）"; S.tagJson.value = ""; return; }
      const obj = parseMinimal(text);
      if (!obj) {
        S.read.textContent = "读取完成：不是本系统的极简格式";
        S.read.className = "err";
        S.tagJson.value = text;
        return;
      }
      S.read.textContent = `读取完成：账户=${obj.a} 余额=${obj.b} 序号=${obj.n}`;
      S.read.className = "ok";
      showJSON(S.tagJson, obj);
    }catch(e){
      S.read.textContent = "读取失败：" + e.message;
      S.read.className = "err";
    }
  });

  $("btnInit").addEventListener("click", async ()=>{
    try{
      const ok = await requireAdminPassword("初始化/重置将覆盖标签内容");
      if(!ok) return;

      const bal = Math.max(0, Math.floor(Number($("initBalance").value || 0)));
      const acc = ($("initAccount").value || "").trim() || uidShort("a");
      const data = sanitizeMinimal({ a: acc, b: bal, n: 0 });
      const text = JSON.stringify(data);

      if (!confirm(`将初始化标签：\n账户=${data.a}\n余额=${data.b}\n确认写入？`)) return;
      await nfcWriteText(text);
      alert("写入完成（NTAG213 极简格式）。");
    }catch(e){
      alert("初始化失败：" + e.message);
    }
  });

  $("btnTopup").addEventListener("click", async ()=>{
    S.topup.textContent = "请贴近要充值的标签...";
    S.topup.className = "muted";
    try{
      const ok = await requireAdminPassword("执行充值需要管理员密码");
      if(!ok){ S.topup.textContent = "已取消"; return; }

      const text = await nfcReadOnce();
      const obj = parseMinimal(text);
      if (!obj) throw new Error("不是本系统的极简格式");

      const amount = Math.max(1, Math.floor(Number($("topupAmount").value || 0)));
      obj.b = Math.max(0, obj.b + amount);
      obj.n += 1;

      const out = JSON.stringify(sanitizeMinimal(obj));
      if (!confirm(`将为账户 ${obj.a} 充值 ${amount}，新余额=${obj.b}。\n确认写入？`)) return;

      await nfcWriteText(out);
      S.topup.textContent = "充值完成";
      S.topup.className = "ok";
      showJSON(S.tagJson, obj);
    }catch(e){
      S.topup.textContent = "充值失败：" + e.message;
      S.topup.className = "err";
    }
  });

  $("btnTransfer").addEventListener("click", async ()=>{
    S.transfer.textContent = "步骤1/4：请贴 A 读取...";
    S.transfer.className = "muted";
    try{
      const amount = Math.max(1, Math.floor(Number($("transferAmount").value || 0)));

      // 读 A
      const textA = await nfcReadOnce();
      const A = parseMinimal(textA);
      if (!A) throw new Error("标签 A 不是本系统极简格式");
      if (A.b < amount) throw new Error("A 余额不足");

      // 确认
      if (!confirm(`确认从账户 A (${A.a}) 转出 ${amount}？\n下一步将读取账户 B。`)) { S.transfer.textContent = "已取消"; return; }

      // 读 B
      S.transfer.textContent = "步骤2/4：请贴 B 读取...";
      const textB = await nfcReadOnce();
      const B = parseMinimal(textB);
      if (!B) throw new Error("标签 B 不是本系统极简格式");
      if (A.a === B.a) throw new Error("A 与 B 相同，禁止转账");

      // 内存更新
      const A2 = sanitizeMinimal(A);
      const B2 = sanitizeMinimal(B);
      A2.b -= amount; A2.n += 1;
      B2.b += amount; B2.n += 1;

      const Aout = JSON.stringify(A2);
      const Bout = JSON.stringify(B2);

      // 写回 A
      S.transfer.textContent = "步骤3/4：请贴近标签 A 写回...";
      if (!confirm(`将从 ${A.a} 向 ${B.a} 转账 ${amount}。\n先写 A，再写 B，确认？`)) { S.transfer.textContent = "已取消"; return; }
      await nfcWriteText(Aout);

      // 写回 B
      S.transfer.textContent = "步骤4/4：请贴近标签 B 写回...";
      await nfcWriteText(Bout);

      S.transfer.textContent = "转账完成";
      S.transfer.className = "ok";
      showJSON(S.tagJson, { A: A2, B: B2 });
    }catch(e){
      S.transfer.textContent = "转账失败：" + e.message + "（若已部分写入，请手动修正）";
      S.transfer.className = "err";
    }
  });
});
</script>
</body>
</html>
