<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFC 简约钱包（共享密码 + HMAC）</title>
<style>
  :root{
    color-scheme: light dark;
    --bg:#0b0c0f; --card:#12141a; --text:#e8ebf1; --muted:#8b90a2;
    --border:#202534; --brand:#3b82f6; --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,PingFang SC,Noto Sans SC,Arial,sans-serif}
  .wrap{max-width:760px;margin:0 auto;padding:14px}
  h1{font-size:1.15rem;margin:10px 0}
  h2{font-size:1rem;margin:12px 0 6px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
  label{display:block;font-size:.9rem;color:var(--muted);margin:6px 0 4px}
  input,textarea,button{width:100%;box-sizing:border-box}
  input,textarea{padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1219;color:var(--text)}
  textarea{min-height:100px}
  button{padding:10px;border-radius:10px;border:1px solid var(--border);background:#111726;color:var(--text);cursor:pointer}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 220px;min-width:220px}
  .primary{background:var(--brand);border-color:transparent;color:#fff}
  .warn{background:var(--warn);border-color:transparent;color:#000}
  .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
  .hr{height:1px;background:var(--border);margin:8px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>NFC 简约钱包（共享密码 + HMAC 校验）</h1>
  <div class="muted">
    - 仅供练习/演示：可被克隆，无法防双花。<br>
    - 需要 Android Chrome/Edge + Web NFC（HTTPS/localhost）。<br>
    - 所有参与者使用同一个密码；不知道密码的人无法伪造有效数据。
  </div>

  <div class="card">
    <h2>全局密码</h2>
    <div class="row">
      <div class="col">
        <label>设置/输入共享密码（重要）</label>
        <input id="pwd" type="password" placeholder="和同学约定一个密码">
      </div>
      <div class="col">
        <label>状态</label>
        <div id="pwdStatus" class="pill">未设置</div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnSavePwd" class="primary">保存到本机（可覆盖）</button>
      <button id="btnClearPwd">清除本机密码</button>
    </div>
  </div>

  <div class="card">
    <h2>读取/验证标签</h2>
    <div class="row">
      <div class="col"><button id="btnRead" class="primary">读取标签并校验</button></div>
      <div class="col"><div id="readStatus" class="muted">尚未读取</div></div>
    </div>
    <div class="hr"></div>
    <label>标签内容（JSON）</label>
    <textarea id="tagJson" readonly></textarea>
  </div>

  <div class="card">
    <h2>初始化/重置标签</h2>
    <div class="row">
      <div class="col">
        <label>初始余额（整数）</label>
        <input id="initBalance" type="number" min="0" step="1" value="1000">
      </div>
      <div class="col">
        <label>账户标识（留空自动生成）</label>
        <input id="initAccount" placeholder="例如：acct-alice、留空自动生成">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnInit" class="warn">初始化/重置（覆盖标签）</button>
    </div>
  </div>

  <div class="card">
    <h2>充值到标签</h2>
    <div class="row">
      <div class="col">
        <label>充值金额（正整数）</label>
        <input id="topupAmount" type="number" min="1" step="1" value="100">
      </div>
      <div class="col muted">需要输入正确的共享密码才能写入。</div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnTopup" class="primary">读取并充值</button>
      <div id="topupStatus" class="muted"></div>
    </div>
  </div>

  <div class="card">
    <h2>标签到标签转账</h2>
    <div class="row">
      <div class="col">
        <label>转账金额（正整数）</label>
        <input id="transferAmount" type="number" min="1" step="1" value="100">
      </div>
      <div class="col muted">流程：读A → 读B → 写A → 写B。需共享密码。</div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnTransfer" class="primary">开始转账流程</button>
      <div id="transferStatus" class="muted"></div>
    </div>
  </div>

  <div class="card">
    <h2>格式与校验</h2>
    <div class="muted">
      数据保存在 NDEF 文本记录（UTF-8 JSON）：<br>
      { "version":1, "account":"...", "balance":123, "nonce":0, "lastTx":{...}, "mac":"base64" }<br>
      - mac = HMAC-SHA-256(secret, JSON(除 mac 外有序字段))。<br>
      - nonce 递增防回放；知道密码者都能更新。<br>
    </div>
  </div>
</div>

<script>
/* ===== 工具 ===== */
const enc = new TextEncoder();
const dec = new TextDecoder();
const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));
const b64 = {
  to: (buf)=> btoa(String.fromCharCode(...new Uint8Array(buf))),
  from: (str)=> Uint8Array.from(atob(str), c=>c.charCodeAt(0)).buffer,
};
function uid(prefix="acct"){
  const a = crypto.getRandomValues(new Uint8Array(6));
  return `${prefix}-${[...a].map(x=>x.toString(16).padStart(2,"0")).join("")}`;
}

/* ===== 密码存储（本机） ===== */
const PWD_KEY = "mini-nfc-secret";
const el = (id)=>document.getElementById(id);
function getPwd(){ return localStorage.getItem(PWD_KEY) || ""; }
function setPwd(p){ localStorage.setItem(PWD_KEY, p); }
function clearPwd(){ localStorage.removeItem(PWD_KEY); }
function refreshPwdStatus(){
  const ok = !!getPwd();
  el("pwdStatus").textContent = ok ? "已设置" : "未设置";
}

async function hmacKeyFromPassword(pwd){
  const raw = enc.encode(pwd);
  return await crypto.subtle.importKey("raw", raw, { name:"HMAC", hash:"SHA-256" }, false, ["sign","verify"]);
}

function sanitizeTag(obj){
  return {
    version: 1,
    account: String(obj.account || ""),
    balance: Number.isFinite(obj.balance) ? Math.max(0, Math.floor(obj.balance)) : 0,
    nonce: Number.isFinite(obj.nonce) ? Math.max(0, Math.floor(obj.nonce)) : 0,
    lastTx: obj.lastTx ? {
      from: String(obj.lastTx.from || ""),
      to: String(obj.lastTx.to || ""),
      amount: Number.isFinite(obj.lastTx.amount) ? Math.max(0, Math.floor(obj.lastTx.amount)) : 0,
      ts: Number.isFinite(obj.lastTx.ts) ? Math.floor(obj.lastTx.ts) : Date.now()
    } : { from:"", to:"", amount:0, ts: Date.now() },
    mac: String(obj.mac || "")
  };
}
function detachMac(obj){ const { mac, ...rest } = obj; return rest; }
function encodePayloadOrdered(objNoMac){
  // 确保顺序稳定
  const payload = {
    version: objNoMac.version,
    account: objNoMac.account,
    balance: objNoMac.balance,
    nonce: objNoMac.nonce,
    lastTx: {
      from: objNoMac.lastTx.from,
      to: objNoMac.lastTx.to,
      amount: objNoMac.lastTx.amount,
      ts: objNoMac.lastTx.ts
    }
  };
  return enc.encode(JSON.stringify(payload));
}
async function macTag(obj, password){
  const clean = sanitizeTag(obj);
  const key = await hmacKeyFromPassword(password);
  const msg = encodePayloadOrdered(detachMac(clean));
  const mac = await crypto.subtle.sign("HMAC", key, msg);
  clean.mac = b64.to(mac);
  return clean;
}
async function verifyTag(obj, password){
  const clean = sanitizeTag(obj);
  if (!clean.mac) return { ok:false, reason:"缺少 MAC" };
  const key = await hmacKeyFromPassword(password);
  const msg = encodePayloadOrdered(detachMac(clean));
  const ok = await crypto.subtle.verify("HMAC", key, b64.from(clean.mac), msg).catch(()=>false);
  return { ok, reason: ok ? "" : "MAC 校验失败（密码不对或数据被改）" };
}

/* ===== Web NFC ===== */
function ensureNFC(){
  if (!("NDEFReader" in window)) throw new Error("此浏览器不支持 Web NFC。请使用 Android Chrome 并开启 NFC。");
}
async function nfcReadOnce(){
  ensureNFC();
  const reader = new NDEFReader();
  await reader.scan();
  return new Promise((resolve, reject)=>{
    const timer = setTimeout(()=>reject(new Error("读取超时")), 30000);
    reader.onreadingerror = e=>{ clearTimeout(timer); reject(new Error("读取失败")); };
    reader.onreading = event=>{
      clearTimeout(timer);
      const { message } = event;
      for (const record of message.records) {
        if (record.recordType === "text" || record.mediaType === "application/json") {
          const text = record.data ? dec.decode(record.data) : record.data || "";
          resolve(text);
          return;
        }
      }
      resolve("");
    };
  });
}
async function nfcWriteText(text){
  ensureNFC();
  const writer = new NDEFReader();
  await writer.write({ records:[{ recordType:"text", data:text }] });
}

/* ===== UI 绑定 ===== */
const S = {
  readStatus: el("readStatus"),
  topupStatus: el("topupStatus"),
  transferStatus: el("transferStatus"),
  tagJson: el("tagJson"),
};

function showJSON(obj){ S.tagJson.value = JSON.stringify(obj, null, 2); }
function parseJSON(text){ try{ return JSON.parse(text); }catch{return null;} }

window.addEventListener("load", ()=>{
  // 初始化密码框
  el("pwd").value = getPwd();
  refreshPwdStatus();

  el("btnSavePwd").addEventListener("click", ()=>{
    const p = (el("pwd").value || "").trim();
    if (!p) return alert("请输入密码");
    setPwd(p);
    refreshPwdStatus();
    alert("密码已保存到本机（localStorage）");
  });
  el("btnClearPwd").addEventListener("click", ()=>{
    clearPwd(); el("pwd").value = ""; refreshPwdStatus();
  });

  el("btnRead").addEventListener("click", async ()=>{
    const pwd = getPwd();
    if (!pwd) return alert("请先设置共享密码");
    S.readStatus.textContent = "请贴近标签读取...";
    S.readStatus.className = "muted";
    try{
      const text = await nfcReadOnce();
      if (!text){ S.readStatus.textContent = "读取完成：无文本记录"; S.readStatus.className="muted"; S.tagJson.value=""; return; }
      const obj0 = parseJSON(text);
      if (!obj0){ S.readStatus.textContent="读取完成：非 JSON"; S.readStatus.className="err"; S.tagJson.value=text; return; }
      const obj = sanitizeTag(obj0);
      const vr = await verifyTag(obj, pwd);
      S.readStatus.textContent = vr.ok ? "读取完成：校验通过" : `读取完成：校验失败（${vr.reason}）`;
      S.readStatus.className = vr.ok ? "ok" : "err";
      showJSON(obj);
    }catch(e){
      S.readStatus.textContent = "读取失败：" + e.message;
      S.readStatus.className = "err";
    }
  });

  el("btnInit").addEventListener("click", async ()=>{
    const pwd = getPwd();
    if (!pwd) return alert("请先设置共享密码");
    try{
      const balance = Math.max(0, Math.floor(Number(el("initBalance").value||0)));
      const account = (el("initAccount").value||"").trim() || uid();
      let obj = { version:1, account, balance, nonce:0, lastTx:{ from:"", to:account, amount:balance, ts:Date.now() } };
      obj = await macTag(obj, pwd);
      const text = JSON.stringify(obj);
      if (text.length > 800) return alert("数据过大，可能超出标签容量");
      if (!confirm(`将初始化账户 ${account}，余额 ${balance}。确认写入？`)) return;
      await nfcWriteText(text);
      alert("写入完成");
    }catch(e){
      alert("初始化失败：" + e.message);
    }
  });

  el("btnTopup").addEventListener("click", async ()=>{
    const pwd = getPwd();
    if (!pwd) return alert("请先设置共享密码");
    S.topupStatus.textContent = "请贴近要充值的标签（读取）...";
    S.topupStatus.className = "muted";
    try{
      const text = await nfcReadOnce();
      const obj0 = parseJSON(text);
      if (!obj0) throw new Error("标签不是有效 JSON");
      const obj = sanitizeTag(obj0);
      const vr = await verifyTag(obj, pwd);
      if (!vr.ok) throw new Error("原始数据校验失败（密码不对或已被改）");
      const amount = Math.max(1, Math.floor(Number(el("topupAmount").value||0)));
      obj.balance += amount;
      obj.nonce += 1;
      obj.lastTx = { from:"external", to: obj.account, amount, ts: Date.now() };
      const obj2 = await macTag(obj, pwd);
      const out = JSON.stringify(obj2);
      if (out.length > 800) throw new Error("数据过大，写入可能失败");
      if (!confirm(`将为 ${obj.account} 充值 ${amount}，确认写入？`)) return;
      await nfcWriteText(out);
      S.topupStatus.textContent = "充值完成";
      S.topupStatus.className = "ok";
      showJSON(obj2);
    }catch(e){
      S.topupStatus.textContent = "充值失败：" + e.message;
      S.topupStatus.className = "err";
    }
  });

  el("btnTransfer").addEventListener("click", async ()=>{
    const pwd = getPwd();
    if (!pwd) return alert("请先设置共享密码");
    const amount = Math.max(1, Math.floor(Number(el("transferAmount").value||0)));
    S.transferStatus.textContent = "步骤1/4：请贴近来源标签 A（读取）...";
    S.transferStatus.className = "muted";

    try{
      // 读 A
      const textA = await nfcReadOnce();
      const A0 = sanitizeTag(parseJSON(textA)||{});
      const vA = await verifyTag(A0, pwd);
      if (!vA.ok) throw new Error("标签A校验失败");
      if (A0.balance < amount) throw new Error("标签A余额不足");

      // 读 B
      S.transferStatus.textContent = "步骤2/4：请贴近目标标签 B（读取）...";
      const textB = await nfcReadOnce();
      const B0 = sanitizeTag(parseJSON(textB)||{});
      const vB = await verifyTag(B0, pwd);
      if (!vB.ok) throw new Error("标签B校验失败");

      // 计算新状态
      const now = Date.now();
      const A1 = { ...A0, balance: A0.balance - amount, nonce: A0.nonce + 1, lastTx:{ from:A0.account, to:B0.account, amount, ts: now } };
      const B1 = { ...B0, balance: B0.balance + amount, nonce: B0.nonce + 1, lastTx:{ from:A0.account, to:B0.account, amount, ts: now } };
      const A2 = await macTag(A1, pwd);
      const B2 = await macTag(B1, pwd);

      // 写 A
      S.transferStatus.textContent = "步骤3/4：请贴近标签 A（写回）...";
      if (!confirm(`将从 ${A0.account} 向 ${B0.account} 转账 ${amount}。按提示依次写入。`)) return;
      await nfcWriteText(JSON.stringify(A2));

      // 写 B
      S.transferStatus.textContent = "步骤4/4：请贴近标签 B（写回）...";
      await nfcWriteText(JSON.stringify(B2));

      S.transferStatus.textContent = "转账完成";
      S.transferStatus.className = "ok";
      showJSON({ A: A2, B: B2 });
    }catch(e){
      S.transferStatus.textContent = "转账失败：" + e.message + "（若已部分写入，请手动修正）";
      S.transferStatus.className = "err";
    }
  });
});
</script>
</body>
</html>
